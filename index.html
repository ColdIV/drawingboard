<!-- @TODO: ADD MOBILE SUPPORT (touchmove) -->
<!-- @TODO: https://stackoverflow.com/questions/13198131/how-to-save-an-html5-canvas-as-an-image-on-a-server -->
<meta name="viewport" content="width=device-width, initial-scale=0.8">

<style>
body {
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: #222;
    color: #ccc;
    overflow: hidden;
}

a {
    user-select: none;
}

#wrapper {
    width: 100%;
    height: 60%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-flow: column;
}

#wrapper > div {
    margin-top: 16px;
    display: flex;
    width: 100%;
    max-width: 400px;
    justify-content: space-between;
}

#wrapper > div > div {
    display: flex;
    align-items: center;
}

#wrapper div button {
    padding: 8px 16px;
    background-color: #111;
    color: #ccc;
    border: 0;
    outline: none;
    cursor: pointer;
    font-family: Verdana, sans-serif;
    font-variant: small-caps;
    letter-spacing: 1;
    
    transition: background-color .25s, color .25s;
}

#wrapper div button + button:last-of-type {
    margin-left: 8px;
}

#wrapper div button:hover {
    background-color: #000;
    color: #bbb;
    
    transition: background-color .25s, color .25s;
}

#wrapper div button:active {
    background-color: #252525;
    color: #ddd;
    
    transition: background-color .25s, color .25s;
}

#toggle-canvas {
    position: fixed;
    bottom: 50px;
    right: 50px;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    background-color: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    cursor: pointer;
    line-height: 1;
    user-select: none;
    z-index: 999;
}

#toggle-canvas #hide-canvas {
    display: none;
}
#toggle-canvas #show-canvas {
    display: block;
}

#toggle-canvas.show #hide-canvas {
    display: block;
}
#toggle-canvas.show #show-canvas {
    display: none;
}

canvas {
    max-width: 400px;
    max-height: 400px;
    background: #111;
    -webkit-box-shadow: 0px 0px 15px 5px #000000; 
    box-shadow: 0px 0px 15px 5px #000000;
}

#gallery {
    position: fixed;
    top: 100vh;
    width: 100%;
    min-height: 100vh;
    background: red;
    
    transition: top, .5s;
}

#gallery.show {
    top: 0vh;
    
    transition: top, .5s;
}

#currentColor {
    width: 150px;
    height: 20px;
    background: rgb(255, 119, 51);
}
</style>


<body onload="init()">
    <div id="wrapper">
        <canvas id="can" width="400" height="400">Below you can write:</canvas>
        <div>
            <div>
                <a href="#" target="_blank">
                    <img src="github.png" height="28px">
                </a>
            </div>
            <div>
                <div id="currentColor"></div>
            </div>
            <div>
                <button>clear</button>
                <button>save</button>
            </div>
        </div>
    </div>
    <div id="toggle-canvas" class="show">
        <span id="show-canvas" title="Show canvas">ðŸ–Œ</span>
        <span id="hide-canvas" title="Show images">ðŸ–¼</span>
    </div>
    <div id="gallery">
    </div>
</body>


<script>
    // CONTROLS:
    let toggleButton = document.querySelector('#toggle-canvas');
    function toggleCanvas (e) {
        e.currentTarget.classList.toggle('show');
        document.querySelector('#gallery').classList.toggle('show');
        return false;
    }
    ['click', 'touch'].forEach(function(e) {
        toggleButton.addEventListener(e, toggleCanvas);
    });
    


    // @SOURCE: https://medium.com/@bantic/hand-coding-a-color-wheel-with-canvas-78256c9d7d43
    // hue in range [0, 360]
    // saturation, value in range [0,1]
    // return [r,g,b] each in range [0,255]
    // See: https://en.wikipedia.org/wiki/HSL_and_HSV#From_HSV
    function hsv2rgb(hue, saturation, value) {
        let chroma = value * saturation;
        let hue1 = hue / 60;
        let x = chroma * (1- Math.abs((hue1 % 2) - 1));
        let r1, g1, b1;
        if (hue1 >= 0 && hue1 <= 1) {
          ([r1, g1, b1] = [chroma, x, 0]);
        } else if (hue1 >= 1 && hue1 <= 2) {
          ([r1, g1, b1] = [x, chroma, 0]);
        } else if (hue1 >= 2 && hue1 <= 3) {
          ([r1, g1, b1] = [0, chroma, x]);
        } else if (hue1 >= 3 && hue1 <= 4) {
          ([r1, g1, b1] = [0, x, chroma]);
        } else if (hue1 >= 4 && hue1 <= 5) {
          ([r1, g1, b1] = [x, 0, chroma]);
        } else if (hue1 >= 5 && hue1 <= 6) {
          ([r1, g1, b1] = [chroma, 0, x]);
        }

        let m = value - chroma;
        let [r,g,b] = [r1+m, g1+m, b1+m];

        // Change r,g,b values from [0,1] to [0,255]
        return [255*r,255*g,255*b];
    }
    
    var HUE = 0;
        HUE_STEPS = 20;
    var COLORARRAY = [];
    var COLOR_INDEX = 0;
    
    for (HUE = 0; HUE <= 360; HUE+=HUE_STEPS) {
        COLORARRAY.push(hsv2rgb(HUE, .80, 1));
    }
    COLORARRAY.push([0,0,0]);
    COLORARRAY.push([255,255,255]);
    
    function circleColor(color, increase = true) {
        if (increase == false) {
            if (1+COLOR_INDEX >= COLORARRAY.length) return COLORARRAY[0];
            return COLORARRAY[1+COLOR_INDEX];
        }
        <!-- console.log(color) -->
        <!-- if (color[0] == 0 && color[1] == 0 && color[2] == 0) { -->
            if (++COLOR_INDEX >= COLORARRAY.length) COLOR_INDEX = 0;
            return COLORARRAY[COLOR_INDEX];
        <!-- } -->
        <!-- if (color[0] == 0 && color[1] == 0 && color[2] == 0) return COLORARRAY[0]; -->
        <!-- for (let i = 0; i < (COLORARRAY.length - 1); ++i) { -->
            <!-- if (parseInt(color[0]) == parseInt(COLORARRAY[i][0]) && -->
                <!-- parseInt(color[1]) == parseInt(COLORARRAY[i][1]) && -->
                <!-- parseInt(color[2]) == parseInt(COLORARRAY[i][2])) { -->
                <!-- return COLORARRAY[i + 1] -->
            <!-- } -->
        <!-- } -->
        
        <!-- return COLORARRAY[0] -->
        return color
    }
    
    
    // @SOURCE: https://stackoverflow.com/a/67723999/10495683 (modified)
    let elementCurrentColor = document.querySelector('#currentColor');
    var canvas, ctx, flag = false,
        prevX = 0,
        currX = 0,
        prevY = 0,
        currY = 0,
        dot_flag = false;

    var x = 'rgb(' + COLORARRAY[0].join(', ') + ')',
        y = 3;
        
    function init() {
        canvas = document.getElementById('can');
        ctx = canvas.getContext("2d");
        w = canvas.width;
        h = canvas.height;

        canvas.addEventListener("mousemove", function (e) {
            findxy('move', e)
        }, false);
        canvas.addEventListener("mousedown", function (e) {
            findxy('down', e)
        }, false);
        canvas.addEventListener("mouseup", function (e) {
            findxy('up', e)
        }, false);
        canvas.addEventListener("mouseout", function (e) {
            findxy('out', e)
        }, false);
    }
     
    function draw() {
        <!-- let color = ctx.getImageData(currX, currY, 1, 1).data; -->
        ctx.beginPath();
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(currX, currY);
        <!-- ctx.strokeStyle = x; -->
        <!-- let tmp = circleColor(color); -->
        <!-- ctx.strokeStyle = 'rgb(' + tmp.join(', ') + ')'; -->
        ctx.lineWidth = y;
        ctx.stroke();
        ctx.closePath();
        <!-- ctx.strokeStyle = COLORARRAY[0]; -->
    }

    function findxy(res, e) {
        if (res == 'down') {
            prevX = currX;
            prevY = currY;
            currX = e.clientX - canvas.getBoundingClientRect().left;
            currY = e.clientY - canvas.getBoundingClientRect().top;

            flag = true;
            dot_flag = true;
            if (dot_flag) {
                ctx.beginPath();
                let color = ctx.getImageData(currX, currY, 1, 1).data;
                let tmp = circleColor(color);
                let tmpColor = 'rgb(' + tmp.join(', ') + ')';
                elementCurrentColor.style.backgroundColor = 'rgb(' + circleColor(tmp, false).join(', ') + ')';
                ctx.fillStyle = tmpColor
                ctx.strokeStyle = tmpColor
                <!-- ctx.fillStyle = x; -->
                ctx.fillRect(currX, currY, 2, 2);
                <!-- ctx.fillStyle = COLORARRAY[0]; -->
                ctx.closePath();
                dot_flag = false;
            }
        }
        if (res == 'up' || res == "out") {
            flag = false;
        }
        if (res == 'move') {
            if (flag) {
                prevX = currX;
                prevY = currY;
                currX = e.clientX - canvas.getBoundingClientRect().left;
                currY = e.clientY - canvas.getBoundingClientRect().top;
                draw();
            }
        }
    }
</script>